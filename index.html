<!DOCTYPE html>
<html>

  <head>
      <meta charset=utf-8 />
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Cache-Control" content="no-cache">

      <title>Real time translate</title>
      <meta name="description"        content="Web Speech API で音声認識した結果を自動翻訳し表示するWebページです。BlackHoleと一緒に利用することで日本語が話せないスタッフとのミーティングなどで利用できます。">
      <meta property="og:title"       content="Real time translate" />
      <meta property="og:description" content="Web Speech API で音声認識した結果を自動翻訳し表示するWebページです。BlackHoleと一緒に利用することで日本語が話せないスタッフとのミーティングなどで利用できます。" />
      <meta name="twitter:card"       content="summary">
  </head>

  <body>
      <div class="main">
          <div id="status" class="error">startup failure</div>
          <div id="help_on_error" class="help_on_error">
              When the microphone does not work → Please reload the page or check your browser settings : <a
              href="https://support.google.com/chrome/answer/2693767?co=GENIE.Platform%3DDesktop&hl=ja&oco=1"
              target="_blank">Chrome Help</a>
          </div>

          <div id="video_wrapper" class="video_wrapper">
              <video id="result_video" class="video_area" autoplay></video>
              <div id="bg_green" class="bg_green hidden"></div>
              <div id="text_overlay_wrapper" class="text_overlay_wrapper full">
                  <div id="result_text" class="text_area">You will see the conversation here. Activate the microphone.</div>
              </div>
          </div>
      </div>
      <script>
          // ブラウザ判定
          // 参考: https://qiita.com/sakuraya/items/33f93e19438d0694a91d
          var userAgent = window.navigator.userAgent.toLowerCase();
          var isChrome = 0;

          if (userAgent.indexOf('msie') != -1 || userAgent.indexOf('trident') != -1) {
              // IE
          } else if (userAgent.indexOf('edge') != -1) {
              // Edge
          } else if (userAgent.indexOf('chrome') != -1) {
              // Chrome
              isChrome = 1;
          } else if (userAgent.indexOf('safari') != -1) {
              // Safari
          } else if (userAgent.indexOf('firefox') != -1) {
              // Firefox
          } else if (userAgent.indexOf('opera') != -1) {
              // Opera
          } else {
              // その他
          }

          if (!isChrome) {
              alert('Go to it on Google Chrome')
              document.getElementById('status').innerHTML = "Go to it on Google Chrome";
              document.getElementById('status').className = "error";
              exit;
          }

          // 音声認識
          // 参考: https://jellyware.jp/kurage/iot/webspeechapi.html
          var flag_speech = 0;
          var recognition;
          var lang = 'ja-JP';

          function vr_function() {
              window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
              recognition = new webkitSpeechRecognition();
              recognition.lang = lang;
              recognition.interimResults = true;
              recognition.continuous = true;
              const p = document.createElement("p");
              p.id = "target";

              recognition.onsoundstart = function () {
                  document.getElementById('status').innerHTML = "We have voice recognition.";
                  document.getElementById('status').className = "processing";

                  document.getElementById('result_text').appendChild(p);
              };
              recognition.onnomatch = function () {
                  document.getElementById('status').innerHTML = "We couldn't recognize your voice.";
                  document.getElementById('status').className = "error";
              };
              recognition.onerror = function () {
                  document.getElementById('status').innerHTML = "error";
                  document.getElementById('status').className = "error";
                  if (flag_speech == 0)
                      vr_function();
              };
              recognition.onsoundend = function () {
                  document.getElementById('status').innerHTML = "Voice recognition has been suspended.";
                  document.getElementById('status').className = "error";
                  vr_function();
              };

              recognition.onresult = function (event) {
                  var results = event.results;
                  for (var i = event.resultIndex; i < results.length; i++) {
                      if (results[i].isFinal) {
                          var result_transcript = results[i][0].transcript
                          var request = "https://script.google.com/macros/s/AKfycbzH5kPvN6nG0XnzfPJhbrxPlBhnb0vOXTdob0WKygLyYX7N2Fg/exec?text=" + result_transcript + "&source=ja&target=en"

                          fetch(request)
                            .then((response) => {
                              if(response.ok) {
                                return response.text();
                              } else {
                                throw new Error();
                              }
                            })
                            .then((text) => p.innerHTML = text)
                            .catch((error) => console.log(error));
                          vr_function();
                          flag_speech = 0;
                          p.removeAttribute('id');
                      } else {
                          p.innerHTML = results[i][0].transcript;
                          flag_speech = 1;
                      }
                  }
              }

              flag_speech = 0;
              document.getElementById('status').innerHTML = "I'm waiting for the conversation to begin.";
              document.getElementById('status').className = "ready";
              recognition.start();
          }

          window.onload = () => {
              vr_function();
          };
      </script>
  </body>

</html>
